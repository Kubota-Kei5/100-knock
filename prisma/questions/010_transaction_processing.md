# 問題010: トランザクション処理（データ整合性★★★★★）

## 問題内容

この問題では**データ整合性**を保つために重要な「**トランザクション処理**」を学習します。

Prismaの`$transaction`を使用して、複数のデータベース操作を安全に実行するプログラムを実装してください。

### 💡 トランザクションとは

**トランザクション**とは、「すべて成功」または「すべて失敗」のどちらかで実行される操作の単位です。

#### 🚨 実務での「やらかし」例

```typescript
// ❌ トランザクションなし（危険）
await prisma.user.delete({ where: { id: 1 } })
// この時点でネットワーク障害が発生したら...
await prisma.post.deleteMany({ where: { authorId: 1 } })
// ユーザーは削除されたが投稿は残る（整合性破綻）
```

```typescript  
// ✅ トランザクションあり（安全）
await prisma.$transaction([
  prisma.user.delete({ where: { id: 1 } }),
  prisma.post.deleteMany({ where: { authorId: 1 } })
])
// すべて成功するか、すべて失敗するかのどちらか
```

### 🎯 トランザクション処理タスク

#### タスク1: 基本的なトランザクション（配列形式）
- **操作**: 複数のユーザー作成を同時実行
- **学習**: 基本的なトランザクション構文

#### タスク2: 関数形式トランザクション
- **操作**: 残高移転のような複雑な処理
- **学習**: 条件判定を含むトランザクション

#### タスク3: トランザクション内でのエラー処理
- **操作**: 意図的にエラーを発生させる
- **学習**: ロールバックの動作確認

#### タスク4: 複雑なビジネスロジック
- **操作**: ブログ投稿とユーザー統計更新
- **学習**: 実務レベルのトランザクション

#### タスク5: トランザクション分離レベル
- **操作**: 読み取り一貫性の確認
- **学習**: 並行処理での整合性

### 🚨 実務での重要ポイント

#### ⚠️ トランザクションが必要な場面
1. **金融取引** - 残高の増減
2. **在庫管理** - 商品の移動・更新
3. **ユーザー登録** - 複数テーブルへの同時登録
4. **データ移行** - 古いデータ削除と新データ作成
5. **統計情報更新** - カウンターの整合性

#### ❌ よくある失敗パターン
- トランザクション範囲が狭すぎる
- 長時間のトランザクション（デッドロック）
- ネストしたトランザクション
- 外部API呼び出しをトランザクション内で実行

### 作業手順

1. 問題009までが完了していることを確認
2. `workspace/problems/problem-010.ts`を実装
3. 各トランザクションパターンを体験
4. エラーケースでのロールバックを確認

### 実行コマンド

```bash
# コンテナに接続
docker-compose exec prisma-app sh

# TypeScriptコンパイル・実行
npx tsc workspace/problems/problem-010.ts --outDir ./temp
node temp/problem-010.js
```

### 期待する出力

```
🔒 トランザクション処理を開始します...

📋 タスク1: 基本的なトランザクション
✅ 複数ユーザーを同時作成しました
  → 山田花子 (ID: 3)
  → 鈴木一郎 (ID: 4)

📋 タスク2: 関数形式トランザクション  
✅ 複雑なブログ投稿処理が完了しました
  → 新規投稿: 「トランザクションについて」
  → 統計更新: 投稿数カウンター +1

📋 タスク3: エラー処理とロールバック
❌ トランザクションが失敗しました
  → すべての変更がロールバックされました
  → データの整合性が保たれています

📋 タスク4: 複雑なビジネスロジック
✅ ユーザー削除と関連データ整理が完了
  → ユーザー削除: 山田花子
  → 関連投稿削除: 2件
  → 統計更新完了

📋 タスク5: 並行処理での整合性
✅ 同時アクセスでも整合性を保持
  → カウンター値: 10 (正確)
```

### 💡 実装のヒント

#### 配列形式トランザクション
```typescript
const result = await prisma.$transaction([
  prisma.user.create({ data: { name: "太郎" } }),
  prisma.user.create({ data: { name: "次郎" } })
])
```

#### 関数形式トランザクション
```typescript
const result = await prisma.$transaction(async (prisma) => {
  const user = await prisma.user.create({ data: { name: "太郎" } })
  const post = await prisma.post.create({ 
    data: { title: "投稿", authorId: user.id }
  })
  return { user, post }
})
```

#### エラー処理
```typescript
try {
  await prisma.$transaction([
    // 何らかの操作
  ])
} catch (error) {
  console.log('トランザクション失敗:', error.message)
}
```

### 🎯 学習目標

- トランザクションの基本概念理解
- 配列形式と関数形式の使い分け
- エラー処理とロールバック動作
- 実務レベルの複雑なトランザクション実装
- データ整合性の重要性認識

### ⚠️ 実務での注意点

1. **トランザクション時間の最小化**
   - 長時間の処理は避ける
   - デッドロック防止

2. **適切な分離レベル選択**
   - READ COMMITTED（デフォルト）
   - SERIALIZABLE（最高レベル）

3. **エラー処理の徹底**
   - try-catch文の必須使用
   - 適切なログ出力

4. **パフォーマンス考慮**
   - 不要なトランザクション回避
   - バッチ処理での工夫

### 🚨 最重要ポイント

**トランザクション**は実務で最も重要な機能の一つです：

- **金融システム**: 残高操作で必須
- **ECサイト**: 在庫・注文処理で必須  
- **SNS**: ユーザー統計更新で重要
- **業務システム**: データ整合性保持で必須

この問題をマスターすることで、**信頼性の高いアプリケーション**を構築できるようになります。