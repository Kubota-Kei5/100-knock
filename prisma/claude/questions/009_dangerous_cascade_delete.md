# 問題009: 危険な削除操作の体験（実務危険度★★★★★）

## 問題内容

この問題では**実務で最も危険**な「**依存関係のある削除操作**」を体験します。

⚠️ **重要**: この問題は**実際にデータ損失**が発生する可能性のある操作を含みます。実務では**絶対に**慎重に行ってください。

### 🚨 DELETE操作の危険性

#### 💥 実務で起こりうる「最悪のやらかし」
1. **CASCADE削除の暴走** - 1つのレコード削除で数千件が消失
2. **外部キー制約エラーの無視** - 整合性を破壊
3. **バックアップなし削除** - 復旧不可能な状況
4. **本番環境での誤操作** - サービス停止レベルの事故

### 🎯 危険な削除の体験タスク

#### タスク1: 外部キー制約による削除失敗（安全な失敗）
- **操作**: 投稿があるユーザーを削除しようとする
- **結果**: 外部キー制約エラーで削除失敗
- **学習**: Prismaの安全機構を理解

#### タスク2: 正しい削除順序の実践
- **操作**: 投稿を先に削除してからユーザーを削除
- **学習**: 依存関係を考慮した削除順序

#### タスク3: CASCADE削除の危険性を体験
- **操作**: スキーマにCASCADE設定を追加
- **結果**: ユーザー削除で関連投稿も自動削除
- **⚠️ 危険**: 意図しない大量削除の可能性

#### タスク4: deleteMany による一括削除の危険性
- **操作**: 条件での一括削除
- **学習**: WHERE条件の重要性
- **危険性**: 条件ミスでの全件削除

#### タスク5: トランザクションによる安全な削除
- **操作**: 複数テーブルの整合性を保った削除
- **学習**: 原子性の重要性

### 🔥 CASCADE削除の設定変更

この問題では一時的にスキーマを変更します：

```prisma
model Post {
  // ... 他のフィールド
  author    User     @relation(fields: [authorId], references: [id], onDelete: Cascade)
  //                                                                  ↑ 危険な設定
}
```

### 🚨 実務での「やらかし」実例

#### ❌ 典型的な事故パターン
```sql
-- 意図: 1人のユーザーを削除
DELETE FROM users WHERE name = 'テストユーザー';

-- 実際: 全投稿も削除される（CASCADE設定のため）
-- 数千件の投稿データが消失...
```

#### ✅ 安全な削除手順
1. **削除影響の事前調査**
2. **バックアップの作成**
3. **トランザクションでの実行**
4. **段階的な削除実行**
5. **結果の検証**

### 作業手順

⚠️ **注意**: 本問題は実際にデータを削除します

1. 問題008までが完了していることを確認
2. スキーマの変更（CASCADE設定追加）
3. マイグレーション実行
4. `workspace/problems/problem-009.ts`を実装
5. **各ステップを慎重に**実行

### 実行コマンド

```bash
# コンテナに接続
docker-compose exec prisma-app sh

# スキーマ変更後のマイグレーション
npx prisma migrate dev --name add-cascade-delete

# TypeScriptコンパイル・実行
npx tsc workspace/problems/problem-009.ts --outDir ./temp
node temp/problem-009.js
```

### 期待する出力

```
⚠️ 危険な削除操作のデモを開始します...

📋 タスク1: 外部キー制約による削除失敗
❌ 田中太郎は削除できませんでした
   → 理由: 投稿データが存在するため

📋 タスク2: 正しい削除順序の実践
✅ 田中太郎の投稿を5件削除しました
✅ 田中太郎を削除しました

📋 タスク3: CASCADE削除の危険性
⚠️ 佐藤次郎を削除します...
✅ 佐藤次郎を削除 → 投稿1件も自動削除されました

📋 タスク4: 一括削除の危険性
⚠️ 条件: age IS NULL のユーザーを削除
✅ 0件のユーザーを削除しました

🚨 全削除データ: ユーザー2人、投稿6件が削除されました
⚠️ このデータは二度と復元できません！
```

### 💡 学習のポイント

#### 1. 外部キー制約の理解
- 参照されているレコードは削除できない
- データ整合性の保護機能

#### 2. CASCADE削除の両面性
- **利便性**: 関連データも自動削除
- **危険性**: 意図しない大量削除

#### 3. 削除前チェックの重要性
- 影響範囲の事前調査
- 関連データ数の確認

#### 4. バックアップと復旧戦略
- 削除前のデータ保存
- ロールバック手順の確立

### 🎯 実務への応用

この問題で体験する内容：

1. **設計フェーズ**: CASCADE設定の慎重な検討
2. **開発フェーズ**: 削除機能のテスト戦略
3. **運用フェーズ**: 本番での削除操作手順
4. **事故対応**: データ復旧の準備

### ⚠️ 最重要注意事項

- **本番環境では絶対にテストしない**
- **削除前に必ずバックアップを作成**
- **削除操作は複数人でダブルチェック**
- **段階的実行とロールバック計画を準備**